# Настройка авторизации через Telegram бота

## Как это работает

Вместо Telegram Login Widget теперь используется авторизация через вашего Telegram бота:

1. Пользователь открывает меню авторизации на сайте
2. Сайт генерирует временный токен (действителен 5 минут)
3. Пользователь получает ссылку на бота с токеном
4. Пользователь переходит в бота и нажимает кнопку "Авторизоваться на сайте"
5. Бот отправляет данные пользователя на API бэкенда
6. Сайт автоматически проверяет статус токена и авторизует пользователя

## Преимущества

✅ Не требует настройки домена в BotFather  
✅ Работает на localhost без дополнительных настроек  
✅ Полный контроль над процессом авторизации  
✅ Можно добавить дополнительные проверки и логику  

## Установка и запуск

### 1. Установите зависимости бота

```bash
cd TelegramBot
pip install -r requirements.txt
```

### 2. Убедитесь, что бэкенд запущен

```bash
cd Backend
python server.py
```

Бэкенд должен быть доступен по адресу `http://localhost:5000`

### 3. Запустите Telegram бота

```bash
cd TelegramBot
python main.py
```

### 4. Настройте переменные окружения (опционально)

Если ваш API бэкенд работает на другом адресе, создайте файл `.env` в корне проекта:

```
BOT_TOKEN=your_bot_token_here
API_URL=http://localhost:5000
PORT=5000
```

### 5. Настройте URL API на фронтенде

В файле `app/components/AuthMenu.tsx` измените `API_URL` если нужно:

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000'
```

Или создайте файл `.env.local` в корне проекта:

```
NEXT_PUBLIC_API_URL=http://localhost:5000
```

## Использование

1. Откройте сайт и нажмите кнопку авторизации
2. Нажмите на ссылку "Открыть бота для авторизации"
3. В боте нажмите кнопку "Авторизоваться на сайте"
4. Вернитесь на сайт - вы будете автоматически авторизованы!

## Структура API

### POST `/api/auth/generate-token`
Генерирует новый токен авторизации.

**Ответ:**
```json
{
  "success": true,
  "token": "abc123...",
  "expires_in": 300
}
```

### POST `/api/auth/verify-token`
Проверяет токен и возвращает данные пользователя, если он авторизован.

**Запрос:**
```json
{
  "token": "abc123..."
}
```

**Ответ (если авторизован):**
```json
{
  "success": true,
  "authorized": true,
  "user": {
    "id": 123456789,
    "first_name": "Иван",
    "last_name": "Иванов",
    "username": "ivanov"
  }
}
```

**Ответ (если не авторизован):**
```json
{
  "success": true,
  "authorized": false,
  "message": "Токен не найден или не авторизован"
}
```

### POST `/api/auth/authorize`
Авторизует токен с данными пользователя (вызывается ботом).

**Запрос:**
```json
{
  "token": "abc123...",
  "user_data": {
    "id": 123456789,
    "first_name": "Иван",
    "last_name": "Иванов",
    "username": "ivanov"
  }
}
```

**Ответ:**
```json
{
  "success": true
}
```

## Безопасность

- Токены действительны только 5 минут
- Токены хранятся в файле `TelegramBot/auth_tokens.json`
- Истекшие токены автоматически удаляются
- Для продакшена рекомендуется использовать Redis или базу данных вместо файлового хранилища

## Устранение неполадок

### Бот не отвечает на команду /start с токеном
- Убедитесь, что бот запущен
- Проверьте логи бота на наличие ошибок

### Авторизация не происходит
- Убедитесь, что бэкенд запущен и доступен
- Проверьте, что `API_URL` в боте правильный
- Проверьте логи бэкенда на наличие ошибок

### Токен истек
- Токены действительны только 5 минут
- Просто закройте и откройте меню авторизации снова для получения нового токена

